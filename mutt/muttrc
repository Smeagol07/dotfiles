# IMAP: offlineimap
set folder = "`echo $HOME`/Maildir"
set mailcap_path=~/.mutt/mailcap
set sendmail = "msmtp.sh"
set postponed = ~/.mutt/postponed
mailboxes = `echo $MAIL` `ls -1d --color=never ~/Maildir/*/* | grep 'INBOX\|sent\|drafts\|archive\|trash' | sed 's#.*Maildir/#+#' | while read line; do echo -n " $line"; done`

set query_command="khard email --parsable '%s'"
macro index,pager \cv "<pipe-message>urlview<return>" "url view"
macro index,pager \ci "<pipe-message>~/.scripts/mail-to-web.sh<return>" "html view in browser"
macro index,pager \ca "<pipe-message>khard add-email" "add the sender address to abook"

macro index,pager \ctp "<pipe-message>email-to-vtodo -f - -p `gpg-config get calendar-personal-path` -c email\n" # add todo entry to personal calendar
macro index,pager \ctw "<pipe-message>email-to-vtodo -f - -p `gpg-config get calendar-work-path` -c email\n"     # add todo entry to work calendar

macro generic,index,pager a "<shell-escape>abook<return>" "launch abook"
bind editor <Tab> complete-query
bind editor \cT complete
bind index,pager r group-reply

# some vim bindings
bind generic,browser,attach,index,pager g noop
bind generic,browser,attach,index N search-opposite
bind generic,browser,attach,index gg first-entry
bind generic,browser,attach,index G last-entry
bind pager gg top
bind pager G bottom

set sort = threads
set edit_headers = yes
# set record = "+sent"
set record = ~/.mutt/sent
set pager_stop = yes
set use_from = yes
set reverse_name = yes
# set nm_record = yes
# set nm_record_tags = "-index +sent +inbox"
set smart_wrap
set wrap=135 # 20 ish is for sidebar
set markers=no
set wait_key=no

# forward with attachments
set mime_forward
set mime_forward_rest=yes

set realname = "Pawel Bogut"
set from = "`gpg-config get email-default-from`"
# Sidebar
set sidebar_visible = yes
set sidebar_format="%B%?F? [%F]?%* %?N?%N/?%S"
set sidebar_divider_char = '│'
set sidebar_width = 30
# Ctrl-n, Ctrl-p to select next, previous folder.
# Ctrl-o to open selected folder.
# Ctrl-v to toggle vfolders with folders
bind index,pager \CP sidebar-prev
bind index,pager \CN sidebar-next
bind index,pager \CO sidebar-open
bind index,pager \CV sidebar-toggle-virtual
# scroll half page
bind pager <space> half-down
bind pager - half-up
bind pager k previous-line
bind pager j next-line

bind compose Y send-message
bind compose y noop
macro compose H ":set editor=mutt-html-markdown.rb<enter>E:set editor=`echo $EDITOR`<enter>a~/.mutt/html-markdown-alternative.html<enter>" "Add html version (markdown)"

macro index,pager \cr '<shell-escape>echo -n "Checking for new emails... " && OFFLINEIMAP_INBOX_ONLY=1 offlineimap > /dev/null 2>&1 <enter>'

# open attachments with rifle
macro attach \CO '<shell-escape>rm -rf /tmp/.mutt-tmp/;mkdir /tmp/.mutt-tmp<enter><save-entry><kill-line>/tmp/.mutt-tmp/<enter>y<enter><shell-escape>i3-open /tmp/.mutt-tmp/* <enter>'
macro compose \CO '<shell-escape>rm -rf /tmp/.mutt-tmp/;mkdir /tmp/.mutt-tmp<enter><save-entry><kill-line>/tmp/.mutt-tmp/<enter>y<enter><shell-escape>i3-open /tmp/.mutt-tmp/* <enter>'
macro attach \CI '<shell-escape>rm -rf /tmp/.mutt-tmp/;mkdir /tmp/.mutt-tmp<enter><save-entry><kill-line>/tmp/.mutt-tmp/tmp-file.html<enter><shell-escape>i3-open /tmp/.mutt-tmp/*<enter>'
# status format with current account info
set status_format="-%r-`gpg-config get email-default-from`: %f [Msgs:%?M?%M/?%m%?n? New:%n?%?o? Old:%o?%?d? Del:%d?%?F? Flag:%F?%?t? Tag:%t?%?p? Post:%p?%?b? Inc:%b?%?l? %l?]---(%s/%S)-%>-(%P)---"

# this can be copied to accounts file to set up different accounts on different machines
# with things that I dont want to keep in public git repository
# switch between accounts
macro index \e1 ":set from=`gpg-config get email-default-from`\n:set status_format=\"-%r-`gpg-config get email-default-from`: %f [Msgs:%?M?%M/?%m%?n? New:%n?%?o? Old:%o?%?d? Del:%d?%?F? Flag:%F?%?t? Tag:%t?%?p? Post:%p?%?b? Inc:%b?%?l? %l?]---(%s/%S)-%>-(%P)---\"\n:my_hdr Bcc: `gpg-config get email-default-from`\n" "Switch to default (`gpg-config get email-default-from`)"
# account specific settings
my_hdr Bcc: `gpg-config get email-default-from`
# alternates `gpg-config get email-alternates`
source ~/.mutt/accounts

# notmuch
set nm_default_uri="notmuch://`echo $HOME`/Maildir" # path to the maildir
set virtual_spoolfile=yes                           # enable virtual folders
virtual-mailboxes \
    "Inbox"         "notmuch://?query=tag:inbox and NOT tag:archive"\
    "Unread"        "notmuch://?query=tag:unread"\
    "Flagged"       "notmuch://?query=tag:flagged"\
    "Sent"          "notmuch://?query=tag:sent and not tag:archive"\
    "Todo"          "notmuch://?query=tag:todo and not (tag:done or tag:archive)"\
    "Projects"      "notmuch://?query=tag:project and not tag:archive"\
    "Github/Gitlab" "notmuch://?query=(tag:github or tag:gitlab) and not tag:archive"\
    "Drafts"        "notmuch://?query=tag:drafts"\
    "Archive"       "notmuch://?query=tag:archive"\
    " `date +'%Y'`" "notmuch://?query=tag:archive and date:`date +'%Y'`"\
    " `expr $(date +'%Y') - 1`" "notmuch://?query=tag:archive and date:`expr $(date +'%Y') - 1`"\
    " `expr $(date +'%Y') - 2`.." "notmuch://?query=tag:archive and date:..`expr $(date +'%Y') - 2`"\
    " sent"         "notmuch://?query=tag:sent and tag:archive"\
    "Other"         "notmuch://?query=not tag:archive and not tag:drafts and not tag:sent and not tag:todo and not tag:* and not tag:unread and not tag:inbox" # sets up queries for

    # project / github (disabled coz slow)
    #`notmuch search --output=tags not tag:archive | grep '^project/' | sed 's#\([^/]*\)\/\(.*\)#" \2" "notmuch://?query=tag:\1/\2 and not tag:archive"#g' | while read l; do echo -n " $l "; done` \
    #`notmuch search --output=tags not tag:archive | grep '^github/' | sed 's#\([^/]*\)\/\(.*\)#" \2" "notmuch://?query=tag:\1/\2 and not tag:archive"#g' | while read l; do echo -n " $l "; done` \


# index format
tag-transforms "inbox"   "i"    \
               "unread"  "✉"    \
               "replied" "↻"    \
               "sent"    "→"    \
               "todo"    "☑"    \
               "archive" "⚛"    \
               "attachment" "⚒" \
               "invites" "≣"

tag-formats "inbox"   "GI" \
            "unread"  "GU" \
            "replied" "GR" \
            "sent"    "GS" \
            "todo"    "GT" \
            "archive" "GA" \
            "attachment" "Ga" \
            "deleted" "GD" \
            "invites" "Gi"

set to_chars=" +TCFL"

# date-cond patch used for conditional date formating
# notmuch tags indicators for todo and archive
set index_format="%4C %T%?GR?%GR& ?%?GT?%GT& ?%?Ga?%Ga& ?%?GA?%GA& ? %<[y?%<[m?%<[d?%[ %H:%M]&%[%a %d]>&%[%b %d]>&%[%m/%y ]> %-15.15L (%<l?%4l&%4c>) %s"

# notmuch bindings
macro pager,index \\ "<vfolder-from-query>"                       # looks up a hand made query
macro pager,index \` "<modify-labels>"                              # change notmuch labels
macro index A "<modify-labels-then-hide>+archive -inbox -unread\n"  # tag as Archived
macro pager A "<modify-labels-then-hide>+archive -inbox -unread\nq" # tag as Archived
macro attach A "qA"                                                 # tag as Archived

macro index T "<modify-labels>+todo -done -inbox\n"                 # tag as Todo
macro index d "<modify-labels>+done\n"                              # tag as Done
macro pager d "<modify-labels>+done\nq"                             # tag as Done
macro attach d "qd"                                                 # tag as Archived
#macro index \cT ":set editor=cat<enter><forward-message>`gpg-config get todoist-default-project-email`<enter><enter>Y:set editor=`echo $EDITOR`<enter>" # tag as Todo
macro index I "<modify-labels>-inbox\n"                             # remove from inbox
macro index B "<modify-labels>+inbox -archive -todo\n"              # remove from inbox
#macro index I "<modify-labels>-inbox -unread\\n"                   # removed from inbox
#macro index S "<modify-labels-then-hide>-inbox -unread +junk\\n"   # tag as Junk mail

macro index P "<modify-labels-then-hide>-inbox +project/"           # tag as project
macro pager P "<modify-labels-then-hide>-inbox +project/"           # tag as project
macro attach P "qP"                                                 # tag as project

# quick jump between boxes
macro index gi "<change-vfolder> Inbox<enter>" "Go to Inbox"
macro index gu "<change-vfolder> Unread<enter>" "Go to Unread"
macro index ga "<change-vfolder> Archive<enter>" "Go to Archive"
macro index gs "<change-vfolder> Sent<enter>" "Go to Sent Mail"
macro index gd "<change-vfolder> Drafts<enter>" "Go to Drafts"
macro index gt "<change-vfolder> Todo<enter>" "Go to Drafts"
macro index gp "<change-vfolder> Projects<enter>" "Go to Projects"

auto_view text/html                                      # view html automatically
# auto_view text/calendar                                  # view ics automatically
alternative_order text/plain text/enriched text/html     # save html for last
set implicit_autoview

# theme
source ~/.mutt/solarized-dark-16.muttrc
#folder-hook ! archive "color index red default \"~Y '\W?archive\W?'\""
