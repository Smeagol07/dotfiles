# IMAP: offlineimap
set folder = "`echo $HOME`/Maildir"
set mailcap_path=~/.mutt/mailcap
set sendmail = "msmtp.sh `get-config.sh email-default-account`"
mailboxes = `ls -1d --color=never ~/Maildir/*/* | grep 'INBOX\|sent\|drafts\|archive\|trash' | sed 's#.*Maildir/#+#' | while read line; do echo -n " $line"; done`

set query_command="abook --mutt-query '%s'"
macro generic,index,pager \ca "<shell-escape>abook<return>" "launch abook"
macro index,pager \cv "<pipe-message>urlview<return>" "url view"
macro index,pager a "<pipe-message>abook --add-email-quiet<return>" "add the sender address to abook"
bind editor <Tab> complete-query
bind editor \cT complete

set sort = threads
set edit_headers = yes
set record = "+sent"
set pager_stop = yes
set use_from = yes
set reverse_name = yes
set nm_record = yes
set nm_record_tags = "-index +sent"

set realname = "Pawel Bogut"
set from = `get-config.sh email-default-from`
# Sidebar
set sidebar_visible = yes
# Ctrl-n, Ctrl-p to select next, previous folder.
# Ctrl-o to open selected folder.
# Ctrl-v to toggle vfolders with folders
bind index,pager \CP sidebar-prev
bind index,pager \CN sidebar-next
bind index,pager \CO sidebar-open
# bind index,pager \CV sidebar-toggle-virtual

macro index,pager \cr '<shell-escape>echo -n "Checking for new emails... " && OFFLINEIMAP_INBOX_ONLY=1 offlineimap > /dev/null 2>&1 <enter>'

# open attachments with xdg-open
macro attach \CO '<shell-escape>rm -rf /tmp/.mutt-tmp/;mkdir /tmp/.mutt-tmp<enter><save-entry><kill-line>/tmp/.mutt-tmp/<enter>y<enter><shell-escape>xdg-open /tmp/.mutt-tmp/* > /dev/null 2>&1 &<enter>'
macro attach \CI '<shell-escape>rm -rf /tmp/.mutt-tmp/;mkdir /tmp/.mutt-tmp<enter><save-entry><kill-line>/tmp/.mutt-tmp/tmp-file.html<enter><shell-escape>xdg-open /tmp/.mutt-tmp/* > /dev/null 2>&1 &<enter>'

# open attachments with xdg-open
macro attach \CO '<shell-escape>rm -rf /tmp/.mutt-tmp/;mkdir /tmp/.mutt-tmp<enter><save-entry><kill-line>/tmp/.mutt-tmp/<enter>y<enter><shell-escape>ranger /tmp/.mutt-tmp/* <enter>'
macro attach \CI '<shell-escape>rm -rf /tmp/.mutt-tmp/;mkdir /tmp/.mutt-tmp<enter><save-entry><kill-line>/tmp/.mutt-tmp/tmp-file.html<enter><shell-escape>ranger /tmp/.mutt-tmp/*<enter>'
# status format with current account info
set status_format="-%r-`get-config.sh email-default-from`: %f [Msgs:%?M?%M/?%m%?n? New:%n?%?o? Old:%o?%?d? Del:%d?%?F? Flag:%F?%?t? Tag:%t?%?p? Post:%p?%?b? Inc:%b?%?l? %l?]---(%s/%S)-%>-(%P)---"

# this can be copied to accounts file to set up different accounts on different machines
# with things that I dont want to keep in public git repository
# switch between accounts
macro index \e1 ":set from=`get-config.sh email-default-from`\n:set status_format=\"-%r-`get-config.sh email-default-from`: %f [Msgs:%?M?%M/?%m%?n? New:%n?%?o? Old:%o?%?d? Del:%d?%?F? Flag:%F?%?t? Tag:%t?%?p? Post:%p?%?b? Inc:%b?%?l? %l?]---(%s/%S)-%>-(%P)---\"\n" "Switch to default (`get-config.sh email-default-from`)"
# account specific settings
send-hook "~f ^`get-config.sh email-default-from`$" 'set sendmail = "msmtp.sh `get-config.sh email-default-account`"; set record="+`get-config.sh email-default-account`/sent"'
# alternates `get-config.sh email-alternates`
source ~/.mutt/accounts

# wrap settings
set smart_wrap
set wrap=135 # 20 ish is for sidebar
set markers=no
set wait_key=no

# notmuch
set nm_default_uri="notmuch://`echo $HOME`/Maildir" # path to the maildir
set virtual_spoolfile=yes                           # enable virtual folders
virtual-mailboxes \
    "Inbox"     "notmuch://?query=(tag:sent or tag:inbox) and NOT tag:archive"\
    "Unread"    "notmuch://?query=tag:unread"\
    "Flagged"   "notmuch://?query=tag:flagged"\
    "Sent"      "notmuch://?query=tag:sent"\
    "Todo"      "notmuch://?query=tag:todo and NOT tag:done"\
    "Drafts"    "notmuch://?query=tag:drafts"\
    "Archive"   "notmuch://?query=tag:archive"\
    "Other"     "notmuch://?query=not tag:archive and not tag:drafts and not tag:sent and not tag:todo and not tag:* and not tag:unread and not tag:inbox" # sets up queries for


# index format
tag-transforms "inbox"   "i"   \
               "unread"  "✉"   \
               "replied" "↻ "  \
               "sent"    "→"  \
               "todo"    "☑"   \
               "archive" "⚓"   \
               "invites" "≣"

tag-formats "inbox"   "GI" \
            "unread"  "GU" \
            "replied" "GR" \
            "sent"    "GS" \
            "todo"    "GT" \
            "archive" "GA" \
            "deleted" "GD" \
            "invites" "Gi"

# date-cond patch used for conditional date formating
# notmuch tags indicators for todo and archive
set index_format="%4C %Z %?GT?%GT& ?%?GA?%GA& ? %<[y?%<[m?%<[d?%[ %H:%M]&%[%a %d]>&%[%b %d]>&%[%m/%y ]> %-15.15L (%<l?%4l&%4c>) %s"

# notmuch bindings
macro pager,index \\\\ "<vfolder-from-query>"              # looks up a hand made query
macro index A "<modify-labels-then-hide>+archive\n"        # tag as Archived
macro pager A "<modify-labels-then-hide>+archive\nq"       # tag as Archived
macro index T "<modify-labels>+todo\n"
#macro index I "<modify-labels>-inbox -unread\\n"                 # removed from inbox
#macro index S "<modify-labels-then-hide>-inbox -unread +junk\\n" # tag as Junk mail

# quick jump between boxes
macro index gi "<change-vfolder> Inbox<enter>" "Go to Inbox"
macro index gu "<change-vfolder> Unread<enter>" "Go to Unread"
macro index ga "<change-vfolder> Archive<enter>" "Go to Archive"
macro index gs "<change-vfolder> Sent<enter>" "Go to Sent Mail"
macro index gd "<change-vfolder> Drafts<enter>" "Go to Drafts"
macro index gt "<change-vfolder> Todo<enter>" "Go to Drafts"

auto_view text/html                                      # view html automatically
auto_view text/calendar                                  # view ics automatically
alternative_order text/plain text/enriched text/html     # save html for last

# theme
source ~/.mutt/solarized-dark-16.muttrc
#folder-hook ! archive "color index red default \"~Y '\W?archive\W?'\""
